class AnimePlayer {
    constructor() {
        this.episodes = [
            {
                title: "E1 - That's How Love Starts, Ya Know!",
                info: "Momo is a high school girl born to a family of spirit mediums, and Okarun is an occult fanatic. To settle an argument, Momo heads to an abandoned hospital famous for UFO sightings while Okarun heads to a tunnel famous as a spiritual hotspot.",
                servers: [
                    { name: "Mega.nz", url: "https://mega.nz/embed/fuQxwJhb#Tr2vfXg_94ZiEEk0m1-FnHlsG_9dHFRz8iQ63RqA6bI" },
                    { name: "Google Drive", url: "https://drive.google.com/file/d/1_FXmtc5Tkston7yNTcFQoGg0Ub_crEHN/preview" }
                ]
            },
            {
                title: "E2 - That's a Space Alien, Ain't It?!",
                info: "Okarun is cursed by Turbo Granny, and Momo uses her newly found psychic powers to curb Turbo Granny from running out of control. Dawn breaks, and the two of them temporarily find shelter in Momo's house.",
                servers: [
                    { name: "Mega.nz", url: "https://mega.nz/embed/2nY2EAAA#anuAtoSJDqUW8R4padsFSATJ9rBo_HiVKKjkSp9KEFQ" },
                    { name: "Google Drive", url: "https://drive.google.com/file/d/1R8ww-sde1K6AFaa69NCNOZumsQfjzyw5/preview" }
                ]
            },
            {
                title: "E3 - It's a Granny vs. Granny Clash!",
                info: "Okarun transforms from Turbo Granny's curse. He goes berserk unable to control his power, but Momo's grandmother Seiko, saves them in the nick of time. To lift the curse, Momo and Okarun decide to play tag with Turbo Granny.",
                servers: [
                    { name: "Mega.nz", url: "https://mega.nz/embed/P6I3hADA#aTFVfVmwPIQ9yTDKcsRvUQZAblNCTp36LF-OggQFJoI" },
                    { name: "Google Drive", url: "https://drive.google.com/file/d/1ik_Myb8vJ3tBEeM0oJzDNnSCZ2U9V_m2/preview" }
                ]
            },
            {
                title: "E4 - Kicking Turbo Granny's Ass",
                info: "To settle the score with Turbo Granny, Momo and Okarun show up at the promised tunnel. They start the game of tag to pull the location-bound spirit away, and they managed to capture Turbo Granny using Momo's psychic powers.",
                servers: [
                    { name: "Mega.nz", url: "https://mega.nz/embed/mjQwkB7Y#WzfdQX0UOW4FE-1lBgBBIQqh36bwwzVRxONWXW4EQQs" },
                    { name: "Google Drive", url: "https://drive.google.com/file/d/1F-JGrHwNcfxI39LGpEAUVlaAewjCQqAt/preview" }
                ]
            },
            {
                title: "E5 - Like, Where Are Your Balls?!",
                info: "Victorious against Turbo Granny, Momo and Okarun regain peace. They have gotten closer through the traumatic experience, but they find their relationship to be awkward. That is when Okarun discloses something important to Momo.",
                servers: [
                    { name: "Mega.nz", url: "https://mega.nz/embed/r2hA2QbZ#g2aT0IIVapvpvYlYBDBU7r2fDGjQyKoiy_1HppjLn7c" },
                    { name: "Google Drive", url: "https://drive.google.com/file/d/1fD4wVJ61shi9pkjjh_JC-Vb4jS21O8Tq/preview" }
                ]
            },
            {
                title: "E6 - A Dangerous Woman Arrives",
                info: "Momo, Okarun, and Turbo Granny search for the missing golden ball. They search all over the school and find out that a pretty girl named Aira is in possession of a ball. Perhaps the effects of the ball, but Aira can now see 'invisible things' now.",
                servers: [
                    { name: "Mega.nz", url: "https://mega.nz/embed/CnYQlTzb#gyT4r3LI66wcC6rmX2L_i-PZmnGpbMDCwduVyYW2viI" },
                    { name: "Google Drive", url: "https://drive.google.com/file/d/15H1DGGgg6Qu4-lUgDHL1GDQ0IQwrosbf/preview" }
                ]
            },
            {
                title: "E7 - To a Kinder World",
                info: "Momo and Okarun manage to pull Acrobatic Silky away from Aira after a fierce battle. However, Aira herself had lost her life as a side-effect of being eaten by a yokai monster. Facing Aira in such a crisis, Acrobatic Silky has a surprising proposal…",
                servers: [
                    { name: "Mega.nz", url: "https://mega.nz/embed/f3JClKAb#NKAHpbQTiAhqDUTgF5zX-MIg4ahwCWUIZSVCA0jF8og" },
                    { name: "Google Drive", url: "https://drive.google.com/file/d/1AZSM2FeUxIlUUYxLts8T8ev8sqqAqOn5/preview" }
                ]
            },
            {
                title: "E8 - I've Got This Funny Feeling",
                info: "The battle against Acrobatic Silky is over, Aira harbors romantic feelings stemming from how Okarun had saved her. As Momo, Okarun, and Aira's feelings intertwine, Serpoians make another appearance, and the three of them are trapped in void space.",
                servers: [
                    { name: "Mega.nz", url: "https://mega.nz/embed/22on1LLY#rQzaTlfdDbm3rFzYrziLV8v_0JTuUFJR_AZq5hWukSs" },
                    { name: "Google Drive", url: "https://drive.google.com/file/d/1GkkCj6KmFrObayOie6BHZOLgJtygyo25/preview" }
                ]
            },
            {
                title: "E9 - Merge! Serpo Dover Demon Nessie!",
                info: "Aira has awakened the powers of Acrobatic Silky within her and proceeds to have a seesaw battle against the Serpoians and the Dover Demon. Momo and Okarun join the fray, intensifying the battle.",
                servers: [
                    { name: "Mega.nz", url: "https://mega.nz/embed/37IkBBJY#SiCk1NQUe6x4Dd1i6MO3ljQWmIKe4MrZEtJE7ZALlzs" },
                    { name: "Google Drive", url: "https://drive.google.com/file/d/1buyo14ZqO06sOwKsUrH7PAt6sHXRRfx0/preview" }
                ]
            },
            {
                title: "E10 - Have You Ever Seen a Cattle Mutilation?",
                info: "Momo, Okarun, and Aira make it through the alien assault by combining their powers. However, the Dover Demon that they thought they had defeated appears before them.",
                servers: [
                    { name: "Mega.nz", url: "https://mega.nz/embed/G3pVXa7Z#GxAL5LdLMSkw5DZUki6laJ0ei2jRJrSozVm53Oaj3rA" },
                    { name: "Google Drive", url: "https://drive.google.com/file/d/1ylZquHws_zSr5I6jpb4i9ZWfzASh2Ff6/preview" }
                ]
            },
            {
                title: "E11 - First Love",
                info: "Momo's childhood friend, Jiji, appears and begins living in Momo's house. Jiji has been worrying about apparitions in the house he moved into. Okarun is clearly disturbed hearing that Jiji is Momo's first love and tries to distance himself from Momo.",
                servers: [
                    { name: "Mega.nz", url: "https://mega.nz/embed/XqJ2HDhI#a78vjptYHYYQm60Z9ENrSuNlRzOWl04w-QPzgKopEjE" },
                    { name: "Google Drive", url: "https://drive.google.com/file/d/1-PGPOUWAgw36Cq6fFLuzfv8vgnARg7DY/preview" }
                ]
            },
            {
                title: "E12 - Let's Go to the Cursed House",
                info: "Momo and Okarun head to Jiji's house in a hot springs district to investigate the case of Jiji's family. Okarun feels gloomy looking at how close Momo and Jiji are. Arriving at Jiji's house, there are several shadows watching them as they enter...",
                servers: [
                    { name: "Mega.nz", url: "https://mega.nz/embed/2n4ygSpb#87RoUpNYGBoX3CP3nNRYSoD72kTAOcBC18euDKikFrI" },
                    { name: "Google Drive", url: "https://drive.google.com/file/d/1LZwq6G9St5hxDY5CoyG_IhcMtIXPPPhI/preview" }
                ]
            }
        ];

        this.currentEpisodeIndex = 0;
        this.currentServerIndex = 0;
        this.isMenuOpen = false;
        this.watchHistory = this.loadWatchHistory();
        
        this.init();
    }

    init() {
        this.createEpisodePicker();
        this.loadSavedProgress();
        this.setupKeyboardControls();
        this.updateSkipButtons();
        this.updateProgressIndicator();
        
        // Load first episode
        this.loadEpisode(this.episodes[this.currentEpisodeIndex]);
    }

    loadSavedProgress() {
        const saved = localStorage.getItem('dandadan-progress');
        if (saved) {
            const progress = JSON.parse(saved);
            this.currentEpisodeIndex = Math.min(progress.episode || 0, this.episodes.length - 1);
            this.currentServerIndex = progress.server || 0;
            
            // Update server dropdown
            document.getElementById('serverDropdown').value = this.currentServerIndex;
        }
    }

    saveProgress() {
        const progress = {
            episode: this.currentEpisodeIndex,
            server: this.currentServerIndex,
            timestamp: Date.now()
        };
        localStorage.setItem('dandadan-progress', JSON.stringify(progress));
    }

    loadWatchHistory() {
        const history = localStorage.getItem('dandadan-history');
        return history ? JSON.parse(history) : [];
    }

    saveWatchHistory() {
        localStorage.setItem('dandadan-history', JSON.stringify(this.watchHistory));
    }

    updateSkipButtons() {
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        
        prevButton.disabled = this.currentEpisodeIndex === 0;
        nextButton.disabled = this.currentEpisodeIndex === this.episodes.length - 1;
        
        // Add visual feedback
        prevButton.style.opacity = prevButton.disabled ? '0.5' : '1';
        nextButton.style.opacity = nextButton.disabled ? '0.5' : '1';
    }

    updateProgressIndicator() {
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        
        const progress = ((this.currentEpisodeIndex + 1) / this.episodes.length) * 100;
        progressFill.style.width = `${progress}%`;
        progressText.textContent = `Episode ${this.currentEpisodeIndex + 1} of ${this.episodes.length}`;
    }

    updateEpisodeInfo(episode) {
        const titleElement = document.getElementById('currentEpisodeTitle');
        const descElement = document.getElementById('currentEpisodeDesc');
        
        // Add loading animation
        document.body.classList.add('loading');
        
        setTimeout(() => {
            titleElement.textContent = episode.title;
            descElement.textContent = episode.info;
            document.body.classList.remove('loading');
        }, 500);
    }

    skipEpisode(direction) {
        const newIndex = this.currentEpisodeIndex + direction;
        if (newIndex >= 0 && newIndex < this.episodes.length) {
            this.currentEpisodeIndex = newIndex;
            this.loadEpisode(this.episodes[this.currentEpisodeIndex]);
            this.updateSkipButtons();
            this.updateProgressIndicator();
            this.saveProgress();
            
            // Add to watch history
            this.addToWatchHistory(this.episodes[this.currentEpisodeIndex]);
        }
    }

    loadEpisode(episode) {
        const wrapper = document.getElementById('videoWrapper');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        // Show loading spinner
        loadingSpinner.style.display = 'block';
        
        // Clear existing iframe
        const existingIframe = wrapper.querySelector('iframe');
        if (existingIframe) {
            existingIframe.remove();
        }
        
        // Create new iframe
        const iframe = document.createElement('iframe');
        const serverUrl = episode.servers[this.currentServerIndex].url;
        iframe.src = serverUrl;
        iframe.allowFullscreen = true;
        iframe.style.display = 'none';
        
        // Handle iframe load
        iframe.onload = () => {
            loadingSpinner.style.display = 'none';
            iframe.style.display = 'block';
        };
        
        wrapper.appendChild(iframe);
        
        // Update episode info and current episode index
        this.currentEpisodeIndex = this.episodes.indexOf(episode);
        this.updateEpisodeInfo(episode);
        this.updateCurrentEpisodeHighlight();
        this.saveProgress();
    }

    updateCurrentEpisodeHighlight() {
        // Remove previous highlights
        document.querySelectorAll('.episode-item').forEach(item => {
            item.classList.remove('current');
        });
        
        // Add current highlight
        const currentItem = document.querySelector(`[data-episode-index="${this.currentEpisodeIndex}"]`);
        if (currentItem) {
            currentItem.classList.add('current');
        }
    }

    createEpisodePicker() {
        const picker = document.getElementById('episodePicker');
        picker.innerHTML = '';
        
        this.episodes.forEach((episode, index) => {
            const item = document.createElement('div');
            item.className = 'episode-item';
            item.setAttribute('data-episode-index', index);
            
            // Check if episode was watched
            const isWatched = this.watchHistory.some(h => h.title === episode.title);
            
            item.onclick = () => {
                this.loadEpisode(episode);
                this.toggleMenu();
                this.updateSkipButtons();
                this.updateProgressIndicator();
                this.addToWatchHistory(episode);
            };
            
            item.innerHTML = `
                <div class="episode-title">
                    ${episode.title}
                    ${isWatched ? '<span style="color: var(--accent-color); margin-left: 8px;">●</span>' : ''}
                </div>
                <div class="episode-description">${episode.info}</div>
            `;
            
            picker.appendChild(item);
        });
        
        this.updateCurrentEpisodeHighlight();
    }

    addToWatchHistory(episode) {
        const existingIndex = this.watchHistory.findIndex(h => h.title === episode.title);
        const historyItem = {
            title: episode.title,
            timestamp: Date.now(),
            episodeIndex: this.episodes.indexOf(episode)
        };
        
        if (existingIndex >= 0) {
            this.watchHistory[existingIndex] = historyItem;
        } else {
            this.watchHistory.push(historyItem);
        }
        
        // Keep only last 50 episodes
        if (this.watchHistory.length > 50) {
            this.watchHistory = this.watchHistory.slice(-50);
        }
        
        this.saveWatchHistory();
    }

    toggleMenu() {
        const menu = document.getElementById('episodeMenu');
        this.isMenuOpen = !this.isMenuOpen;
        
        if (this.isMenuOpen) {
            menu.classList.add('open');
            document.body.style.overflow = 'hidden';
        } else {
            menu.classList.remove('open');
            document.body.style.overflow = 'auto';
        }
    }

    changeServer() {
        this.currentServerIndex = parseInt(document.getElementById('serverDropdown').value);
        this.loadEpisode(this.episodes[this.currentEpisodeIndex]);
        this.saveProgress();
        
        // Show notification
        this.showNotification(`Switched to ${this.episodes[this.currentEpisodeIndex].servers[this.currentServerIndex].name}`);
    }

    showNotification(message) {
        // Create notification element
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 100px;
            right: 30px;
            background: var(--surface);
            color: var(--text-primary);
            padding: 15px 20px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 30px var(--shadow);
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    setupKeyboardControls() {
        document.addEventListener('keydown', (e) => {
            // Ignore if typing in input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    this.skipEpisode(-1);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    this.skipEpisode(1);
                    break;
                case 'Escape':
                    if (this.isMenuOpen) {
                        this.toggleMenu();
                    }
                    break;
                case ' ':
                    e.preventDefault();
                    this.toggleMenu();
                    break;
                case 'f':
                case 'F':
                    e.preventDefault();
                    this.toggleFullscreen();
                    break;
            }
        });
    }

    toggleFullscreen() {
        const playerContainer = document.querySelector('.player-container');
        
        if (!document.fullscreenElement) {
            playerContainer.requestFullscreen().catch(err => {
                console.log(`Error attempting to enable fullscreen: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }
}

// Global functions for HTML onclick handlers
let player;

function skipEpisode(direction) {
    player.skipEpisode(direction);
}

function toggleMenu() {
    player.toggleMenu();
}

function changeServer() {
    player.changeServer();
}

function toggleFullscreen() {
    player.toggleFullscreen();
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    player = new AnimePlayer();
    
    // Add smooth scrolling for better UX
    document.documentElement.style.scrollBehavior = 'smooth';
    
    // Add loading animation
    document.body.style.opacity = '0';
    setTimeout(() => {
        document.body.style.transition = 'opacity 0.5s ease';
        document.body.style.opacity = '1';
    }, 100);
});

// Handle page visibility changes
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        // Page is hidden, could pause video or save state
        player.saveProgress();
    }
});

// Handle beforeunload to save progress
window.addEventListener('beforeunload', () => {
    player.saveProgress();
});
